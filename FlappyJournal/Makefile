# Featherweight FlappyJournal Makefile
# Quick commands for development and testing

.PHONY: help test-env-up test-env-down test-env-logs test-env-status

help:
	@echo "Available targets:"
	@echo "  test-env-up      - Start the isolated test environment"
	@echo "  test-env-down    - Stop and remove the test environment"
	@echo "  test-env-logs    - View test environment logs"
	@echo "  test-env-status  - Check test environment status"
	@echo "  help             - Show this help message"

# Start the test environment
test-env-up:
	@echo "ğŸš€ Starting test environment..."
	@cd /opt/featherweight/test-env && \
	docker-compose -f docker-compose.override.yml up -d
	@echo "âœ… Test environment started!"
	@echo "ğŸ“Š API Gateway: http://localhost:4010"
	@echo "ğŸ” Auth Service: http://localhost:4011"
	@echo "ğŸ’­ Chat Orchestrator: http://localhost:4012"
	@echo "ğŸ§  Consciousness Backend: http://localhost:4013"
	@echo "ğŸŒ WebSocket Server: http://localhost:4014"
	@echo "ğŸ”Œ WebSocket Port: 4015"
	@echo "ğŸ—„ï¸  Test Database: localhost:5433"
	@echo "ğŸ“¦ Test Redis: localhost:6380"

# Stop the test environment
test-env-down:
	@echo "ğŸ›‘ Stopping test environment..."
	@cd /opt/featherweight/test-env && \
	docker-compose -f docker-compose.override.yml down -v
	@echo "âœ… Test environment stopped and volumes cleaned!"

# View test environment logs
test-env-logs:
	@echo "ğŸ“œ Viewing test environment logs..."
	@cd /opt/featherweight/test-env && \
	docker-compose -f docker-compose.override.yml logs -f

# Check test environment status
test-env-status:
	@echo "ğŸ“Š Test environment status:"
	@cd /opt/featherweight/test-env && \
	docker-compose -f docker-compose.override.yml ps

# Quick restart for development
test-env-restart: test-env-down test-env-up

# Run tests against the test environment
test-env-test:
	@echo "ğŸ§ª Running tests against test environment..."
	@cd /opt/featherweight/FlappyJournal && \
	npm test -- --testTimeout=30000

# Cypress E2E Test Suite with Docker
.PHONY: test-e2e test-e2e-docker cypress-setup

# Install Cypress dependencies
cypress-setup:
	@echo "ğŸ”§ Setting up Cypress environment..."
	npm install cypress mocha-junit-reporter cypress-multi-reporters --save-dev
	mkdir -p ./artifacts/cypress/videos ./artifacts/cypress/screenshots ./artifacts/junit

# Run Cypress E2E tests locally
test-e2e: cypress-setup
	@echo "ğŸ§ª Running Cypress E2E tests locally..."
	npx cypress run \
		--config-file cypress.junit.config.js \
		--spec "cypress/e2e/comprehensive-e2e-suite.cy.js" \
		--reporter mocha-junit-reporter \
		--reporter-options "mochaFile=./artifacts/junit/test-results-[hash].xml"

# Run Cypress E2E tests with Docker (recommended)
test-e2e-docker: 
	@echo "ğŸ³ Running Cypress E2E tests with Docker..."
	./run-cypress-e2e.sh

# Run comprehensive E2E validation
test-e2e-comprehensive: cypress-setup
	@echo "ğŸ¯ Running comprehensive E2E validation..."
	npx cypress run \
		--config-file cypress.junit.config.js \
		--reporter mocha-junit-reporter \
		--reporter-options "mochaFile=./artifacts/junit/comprehensive-results-[hash].xml"

# Clean test artifacts
clean-test-artifacts:
	@echo "ğŸ§¹ Cleaning test artifacts..."
	rm -rf ./artifacts/cypress/videos/*
	rm -rf ./artifacts/cypress/screenshots/*
	rm -rf ./artifacts/junit/*


# Access Code System
.PHONY: test-access-code setup-access-system start-with-access

test-access-code:
	@echo "ğŸ”“ Testing access code system..."
	@echo "ğŸš€ Starting server in background..."
	@cd server && npm start > /dev/null 2>&1 & echo $$! > server.pid
	@sleep 3
	@echo "ğŸ§ª Running access code tests..."
	@node test-access-code.js
	@echo "ğŸ›‘ Stopping server..."
	@kill `cat server/server.pid` 2>/dev/null || true
	@rm -f server/server.pid

setup-access-system:
	@echo "ğŸ” Setting up access code system..."
	@echo "ğŸ“¦ Installing server dependencies..."
	@cd server && npm install
	@echo "ğŸ¯ Global access code set to: g00dnews"
	@echo "âœ… Access code system ready!"
	@echo ""
	@echo "ğŸŒŸ Next steps:"
	@echo "   1. Run 'make start-with-access' to start the full system"
	@echo "   2. Visit app.featherweight.world"
	@echo "   3. Enter access code: g00dnews"
	@echo "   4. Enjoy full platform access!"

start-with-access:
	@echo "ğŸš€ Starting Featherweight with access code protection..."
	@echo "ğŸ” Global access code: g00dnews"
	@echo "ğŸŒ Client will be available at http://localhost:3000"
	@echo "ğŸ”§ Server API at http://localhost:3001"
	@echo ""
	@echo "ğŸ’¡ Users will need to enter 'g00dnews' to access the platform"
	@echo ""
	@# Start server and client concurrently
	@(cd server && npm start) & \
	(cd client && npm run dev) & \
	wait

