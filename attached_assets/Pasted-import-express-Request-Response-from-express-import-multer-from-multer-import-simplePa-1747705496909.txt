import express, { Request, Response } from 'express';
import multer from 'multer';
import { simpleParser } from 'mailparser';

const app = express();
const upload = multer();  // multer for multipart/form-data

// -------------------------------
// OPTION A: MULTER (multipart/form-data)
// -------------------------------
app.post(
  "/api/emails/webhook-multipart",
  upload.none(),                // parses text fields into req.body
  async (req: Request, res: Response) => {
    console.log('ğŸ“ [Multipart] Content-Type:', req.headers['content-type']);
    console.log('ğŸ“ [Multipart] Parsed body keys:', Object.keys(req.body));
    console.log('ğŸ“ [Multipart] Payload:', req.body);
    // Now you can access: req.body.from, req.body.to, req.body.subject, req.body.text
    // â€¦ your enqueue / processing logic â€¦
    res.status(200).send('ok (multipart)');
  }
);

// -------------------------------
// OPTION B: RAW MIME (if you checked "POST raw MIME" in SendGrid)
// -------------------------------
app.post(
  "/api/emails/webhook-raw",
  express.raw({ type: '*/*', limit: '50mb' }),  // raw buffer for full MIME
  async (req: Request, res: Response) => {
    console.log('ğŸ“ [Raw] Content-Type:', req.headers['content-type']);
    try {
      const parsed = await simpleParser(req.body as Buffer);
      console.log('ğŸ“ [Raw] From:', parsed.from?.text);
      console.log('ğŸ“ [Raw] Subject:', parsed.subject);
      console.log('ğŸ“ [Raw] Text Body:', parsed.text);
      // â€¦ your enqueue / processing logic using parsed object â€¦
      res.status(200).send('ok (raw)');
    } catch (err) {
      console.error('âš ï¸ [Raw] Parse error:', err);
      res.status(500).send('parse-error');
    }
  }
);

// --------------------------------
// To test locally, hit:
// POST /api/emails/webhook-multipart   (with form-data)
// POST /api/emails/webhook-raw         (with raw .eml body)
// --------------------------------

app.listen(process.env.PORT || 3000, () => {
  console.log('ğŸš€ Server is live');
});
How to use:

If youâ€™re using SendGrid Inbound Parse with form fields, call /api/emails/webhook-multipart.

If you enabled â€œPOST raw, full MIMEâ€ in SendGrid, call /api/emails/webhook-raw.

You can keep both routes active or comment out whichever you donâ€™t need. Copyâ€“paste this into your Replit server/routes.ts (or main file), deploy, then send a real email to see which one logs your payload correctly.